<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BN ATI Report</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    table.dataTable { width: 100% !important; }
    .dt-right { text-align: right; }
  </style>
</head>
<body>
  <h1>Briefing Note ATI Report</h1>

  <p>Generated on: <gcds-date-modified>{{ build_date }}</gcds-date-modified></p>

  <h2>Section 1: Strong Matches</h2>
  <table id="report" class="display nowrap"></table>

  <h2>Section 2: Weak Matches</h2>
  <div id="weak-table"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script type="module">
    import { createDbWorker } from "https://unpkg.com/sql.js-httpvfs/dist/sqlite.worker.js";

    (async () => {
      const worker = await createDbWorker(
        [{
          from: "inline",
          config: {
            serverMode: "full",
            requestChunkSize: 4096,
            url: "./data.sqlite"
          }
        }],
        "https://unpkg.com/sql.js-httpvfs/dist/sqlite.worker.sql-wasm.js"
      );

      async function q(sql, params=[]) {
        return await worker.db.query(sql, params);
      }

      // DataTable
      const table = $('#report').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        scrollX: true,
        lengthMenu: [[10,25,50,100],[10,25,50,100]],
        ajax: async (data, callback) => {
          const start = data.start || 0;
          const length = data.length || 25;
          const colMap = ["owner_org","tracking_number","request_number","informal_requests_sum","unique_identifiers"];
          const orderCol = colMap[(data.order?.[0]?.column ?? 0)] || "owner_org";
          const orderDir = (data.order?.[0]?.dir ?? "asc").toUpperCase() === "DESC" ? "DESC" : "ASC";

          const totalRes = await q("SELECT COUNT(*) AS c FROM strong_matches");
          const recordsTotal = totalRes[0]?.c || 0;

          const rows = await q(
            `SELECT owner_org, tracking_number, request_number, informal_requests_sum, unique_identifiers, summary_en, summary_fr
             FROM strong_matches
             ORDER BY ${orderCol} ${orderDir}
             LIMIT ? OFFSET ?`,
            [length, start]
          );

          const dataRows = rows.map(r => [
            r.owner_org,
            r.tracking_number,
            r.request_number,
            r.informal_requests_sum || 0,
            r.unique_identifiers || "",
            r.summary_en || "",
            r.summary_fr || ""
          ]);

          callback({
            draw: data.draw,
            recordsTotal,
            recordsFiltered: recordsTotal,
            data: dataRows
          });
        },
        columns: [
          { title: "Org", data: 0 },
          { title: "Tracking #", data: 1, render: (d,t,row)=>
            `<a href="https://search.open.canada.ca/briefing_titles/record/${row[0]},${d}" target="_blank">${d}</a>` },
          { title: "Request #", data: 2, render: (d,t,row)=>
            `<a href="https://open.canada.ca/data/en/dataset/0797e893-751e-4695-8229-a5066e4fe43c/resource/19383ca2-b01a-487d-88f7-e1ffbc7d39c2?filters=owner_org%3A${row[0]}%7Crequest_number%3A${d}" target="_blank">${d}</a>` },
          { title: "Informal Requests", data: 3, className:'dt-right', render:(d)=>Number(d||0).toLocaleString() },
          { title: "UIDs", data: 4 },
          { title: "Summary EN", data: 5, visible:false },
          { title: "Summary FR", data: 6, visible:false }
        ]
      });

      // Expand details to show summaries
      $('#report tbody').on('click', 'tr', function () {
        const row = table.row(this);
        if (row.child.isShown()) {
          row.child.hide(); $(this).removeClass('shown');
        } else {
          const d = row.data();
          row.child(`<div><strong>EN:</strong> ${d[5]}<br><strong>FR:</strong> ${d[6]}</div>`).show();
          $(this).addClass('shown');
        }
      });

      // Weak table
      const weakRows = await q(`SELECT owner_org, tracking_number, COUNT(*) as n
                                FROM weak_matches GROUP BY owner_org, tracking_number`);
      let html = "<table border='1'><tr><th>Org</th><th>Tracking #</th><th>Count</th></tr>";
      weakRows.forEach(r=>{
        html += `<tr><td>${r.owner_org}</td><td>${r.tracking_number}</td><td>${r.n}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("weak-table").innerHTML = html;
    })();
  </script>
</body>
</html>
