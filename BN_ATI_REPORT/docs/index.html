<!-- BN_ATI_REPORT/templates/index.html -->
<!-- TODO: Remove all comments before deploying your code to production. -->
<!DOCTYPE html>
<html dir="ltr" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- TODO: Add a description for SEO/sharing. -->
    <meta name="description" content="BN ATI Report" />

    <title>ATI Requests for Proactively Published Briefing Note Titles and Numbers</title>


    <!-- GC Design System -->
    <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-utility@1.9.2/dist/gcds-utility.min.css" />
    <link rel="stylesheet" href="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.40.0/dist/gcds/gcds.css" />
    <script type="module" src="https://cdn.design-system.alpha.canada.ca/@cdssnc/gcds-components@0.40.0/dist/gcds/gcds.esm.js"></script>

    <!-- DataTables core + SearchBuilder (CSS only; JS injected by script) -->
  
    <style>
      td.small{max-width:56ch;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .pill{display:inline-block;padding:.15rem .4rem;border-radius:999px;background:#eef;font-size:.85em;margin-right:.25rem}
      .table-wrap{margin-block: 1.5rem;}
      table.dataTable {width:100% !important}
      table.dataTable tr.shown td { background: #f9fbff; }
      .dt-details { padding: .75rem 1rem; line-height: 1.35; }
      .dt-details h4 { margin:.2rem 0 .4rem; font-size:1rem; }
      .dt-details p { margin:.25rem 0; }
      .preset-bar { display:flex; gap:.5rem; flex-wrap:wrap; margin: .5rem 0 1rem; }
    </style>
  </head>

  <body>
    <!---------- Header ---------->
    <gcds-header lang-href="#" skip-to-href="#main-content">
      <gcds-search slot="search"></gcds-search>
      <gcds-breadcrumbs slot="breadcrumb">
        <gcds-breadcrumbs-item href="#">Link</gcds-breadcrumbs-item>
        <gcds-breadcrumbs-item href="#">Link</gcds-breadcrumbs-item>
      </gcds-breadcrumbs>
    </gcds-header>

    <!---------- Main content ---------->
    <gcds-container
      id="main-content"
      main-container
      size="full"
      centered
      tag="main"
    >
      <section>
        <gcds-heading tag="h1">ATI Requests for Proactively Published Briefing Note Titles and Numbers</gcds-heading>
        <gcds-text>
          In accordance with the Access to Information Act, the government proactively publishes titles and reference numbers of memoranda received by ministers and deputy heads. These are often requested under the ATIA.
        </gcds-text>
      </section>

      <!-- ▶︎ SECTION 1 (DataTables lives here) -->
      <section id="section-1">
        <gcds-heading tag="h2">Combined Data</gcds-heading>
        <!-- Stats populated here -->
        <gcds-text id="bn-ati-stats"></gcds-text>

         <div class="preset-bar">
          <gcds-button id="preset-weak" type="button" button-role="secondary">
            Apply: Remove Weak BN IDs
          </gcds-button>
          <gcds-button id="preset-informal" type="button" button-role="secondary">
            Apply: Only Records Informally Requested
          </gcds-button>
          <gcds-button id="preset-clear" type="button">
            Clear Filters
          </gcds-button>
        </div>

        <div class="table-wrap">
          <gcds-heading tag="h3">Index of Records</gcds-heading>
          <table id="report" class="display">
            <thead>
              <tr>
                <th>owner_org</th>
                <th>tracking_number</th>
                <th>request_number</th>
                <th>Informal Requests (sum)</th>
                <th>Unique Identifier(s)</th>
                <th>summary_en</th>
                <th>summary_fr</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section>
        <gcds-heading tag="h2">Section 2</gcds-heading>
        <gcds-text>Additional content.</gcds-text>
      </section>

      <section>
        <gcds-heading tag="h2">Section 3</gcds-heading>
        <gcds-text>Additional content.</gcds-text>
      </section>

      <gcds-date-modified>2024-08-22</gcds-date-modified>
    </gcds-container>

    <!---------- Footer ---------->
    <gcds-footer
      display="full"
      contextual-heading="Open Government Portal Reports"
      contextual-links='{ "GitHub": "https://github.com/open-data/analytics-corporate-reporting","Analytics Open Data": "https://open.canada.ca/data/en/dataset/2916fad5-ebcc-4c86-b0f3-4f619b29f412", "Open Government Analytics": "https://open.canada.ca/en/content/open-government-analytics"}'
    >
    </gcds-footer>

    
<script>
(function(){
  // ---------- tiny helpers for dynamic assets ----------
  function addCSS(href){
    return new Promise(function(resolve,reject){
      if ([...document.styleSheets].some(s => s.href && s.href.includes(href))) return resolve();
      const l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
      l.onload=resolve; l.onerror=reject; document.head.appendChild(l);
    });
  }
  function addScript(src){
    return new Promise(function(resolve,reject){
      if ([...document.scripts].some(s => s.src && s.src.includes(src))) return resolve();
      const s=document.createElement('script'); s.src=src; s.defer=true;
      s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }

  // ---------- ensure DataTables v2 + SearchBuilder 1.8.3 ----------
  async function ensureDataTables2(){
    if (!window.jQuery) await addScript("https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js");
    await addCSS("https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css");
    await addScript("https://cdn.datatables.net/2.0.8/js/dataTables.min.js");
    await addCSS("https://cdn.datatables.net/searchbuilder/1.8.3/css/searchBuilder.dataTables.min.css");
    await addScript("https://cdn.datatables.net/searchbuilder/1.8.3/js/dataTables.searchBuilder.min.js");
  }

  // ---------- IndexedDB (simple wrapper) ----------
  const DB_NAME = "bn_ati_cache";
  const STORE = "reports";
  const KEY = "report_v1"; // bump if JSON schema changes

  function idbOpen(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  async function idbGet(key){
    try{
      const db = await idbOpen();
      return await new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readonly");
        const store = tx.objectStore(STORE);
        const req = store.get(key);
        req.onsuccess = () => resolve(req.result || null);
        req.onerror = () => reject(req.error);
      });
    }catch(e){ console.warn("idbGet failed", e); return null; }
  }
  async function idbPut(key, value){
    try{
      const db = await idbOpen();
      return await new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, "readwrite");
        const store = tx.objectStore(STORE);
        const req = store.put(value, key);
        req.onsuccess = () => resolve(true);
        req.onerror = () => reject(req.error);
      });
    }catch(e){ console.warn("idbPut failed", e); return false; }
  }

  // ---------- utilities ----------
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }
  function linkOwnerOrg(val){
    const raw = String(val || '');
    const slug = encodeURIComponent(raw.toLowerCase());
    const url = `https://search.open.canada.ca/briefing_titles/?owner_org=${slug}`;
    return `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(raw)}</a>`;
  }
  function linkUIDs(val){
    const raw = String(val || '');
    if (!raw.trim()) return '';
    const parts = raw.split(';').map(s => s.trim()).filter(Boolean);
    const base = "https://open.canada.ca/en/search/ati/reference/";
    return parts.map(id => `<a href="${base}${encodeURIComponent(id)}" target="_blank" rel="noopener">${escapeHtml(id)}</a>`).join("<br>");
  }
  function buildDetails(row){
    // row = [owner_org, tracking_number, request_number, sum, unique_ids, summary_en, summary_fr]
    return `
      <div class="dt-details">
        <h4>Full details</h4>
        <p><strong>owner_org:</strong> ${escapeHtml(row[0])}</p>
        <p><strong>tracking_number:</strong> ${escapeHtml(row[1])}</p>
        <p><strong>request_number:</strong> ${escapeHtml(row[2])}</p>
        <p><strong>Informal Requests (sum):</strong> ${Number(row[3] || 0).toLocaleString()}</p>
        <p><strong>Unique Identifier(s):</strong><br>${linkUIDs(row[4])}</p>
        <p><strong>summary_en:</strong><br>${escapeHtml(row[5])}</p>
        <p><strong>summary_fr:</strong><br>${escapeHtml(row[6])}</p>
      </div>`;
  }
  function toRows(json){
    return (json?.rows || []).map(r => ([
      r.owner_org || '',
      r.tracking_number || '',
      r.c_request_number || '',
      (r.informal_requests_sum || 0),
      r.unique_identifiers || '',
      r.summary_en || '',
      r.summary_fr || ''
    ]));
  }
  function updateStats(data){
    const statsEl = document.getElementById('bn-ati-stats');
    if (!statsEl) return;
    statsEl.innerHTML =
      `<strong>Summary</strong> — ` +
      `A: ${Number(data.meta?.counts?.A_rows||0).toLocaleString()} · ` +
      `B: ${Number(data.meta?.counts?.B_rows||0).toLocaleString()} · ` +
      `C: ${Number(data.meta?.counts?.C_rows||0).toLocaleString()} · ` +
      `BC: ${Number(data.meta?.counts?.BC_rows||0).toLocaleString()} · ` +
      `Matches: ${Number(data.meta?.counts?.matches||0).toLocaleString()} · ` +
      `Strong: ${Number(data.meta?.counts?.strong_matches||0).toLocaleString()} · ` +
      `Weak: ${Number(data.meta?.counts?.weak_matches||0).toLocaleString()}`;
  }

  // Only Records Informally Requested preset
  const PRESET_INFORMAL = {
    criteria: [{ data: 'Informal Requests (sum)', condition: '>=', value: [1] }],
    logic: 'AND'
  };

  async function main(){
    await ensureDataTables2();

    const tableEl = document.getElementById('report');

    // 1) IndexedDB-first: if cached exists, use it; otherwise fetch from web once and cache it.
    let data = await idbGet(KEY);
    if (!data){
      try{
        const res = await fetch('./report.json', { cache: 'no-store' });
        data = await res.json();
        await idbPut(KEY, data);
      }catch(e){
        console.error("Failed to fetch report.json and no cache available.", e);
        return;
      }
    }

    // Initialize table from cached (or freshly fetched) data
    updateStats(data);
    const rows = toRows(data);
    const dt = jQuery(tableEl).DataTable({
      data: rows,
      deferRender: true,
      autoWidth: false,
      pageLength: 25,
      lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"All"]],
      order: [[0, "asc"]],
      dom: 'Qlfrtip',
      searchBuilder: { columns: [0,1,2,3,4,5,6] },
      columns: [
        { data: 0, render: (d,t)=> t==='display' ? linkOwnerOrg(d) : (d ?? '') },
        { data: 1 },
        { data: 2 },
        { data: 3, className:'dt-right',
          render:(d,t)=>{const n=Number(d||0); return t==='display'? n.toLocaleString(): n;} },
        { data: 4, render:(d,t)=> t==='display' ? linkUIDs(d) : (d ?? '') },
        { data: 5, className:'small' },
        { data: 6, className:'small' }
      ]
    });

    // Row expansion toggle
    jQuery('#report tbody').on('click', 'tr', function(){
      const row = dt.row(this);
      if (row.child.isShown()) { row.child.hide(); jQuery(this).removeClass('shown'); }
      else { row.child(buildDetails(row.data())).show(); jQuery(this).addClass('shown'); }
    });

    // Preset buttons (no weak preset anymore)
    const btnInformal = document.getElementById('preset-informal');
    const btnClear = document.getElementById('preset-clear');
    if (btnInformal) btnInformal.addEventListener('click', () => dt.searchBuilder.rebuild(PRESET_INFORMAL));
    if (btnClear) btnClear.addEventListener('click', () => dt.searchBuilder.rebuild());
  }

  main().catch(console.error);
})();
</script>

  </body>
</html>
