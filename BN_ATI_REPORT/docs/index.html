<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BN ATI Report</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    body { font-family: sans-serif; margin: 2rem; }
    table.dataTable { width: 100% !important; }
    .dt-right { text-align: right; }
  </style>
</head>
<body>
  <h1>Briefing Note ATI Report</h1>

  <p>Generated on: <gcds-date-modified>2025-08-19</gcds-date-modified></p>

  <h2>Section 1: Strong Matches</h2>
  <table id="report" class="display nowrap"></table>

  <h2>Section 2: Weak Matches</h2>
  <div id="weak-table"></div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script type="module">
    import { createDbWorker } from "https://unpkg.com/sql.js-httpvfs/dist/sqlite.worker.js";

    (async () => {
      const worker = await createDbWorker(
        [{
          from: "inline",
          config: {
            serverMode: "full",
            requestChunkSize: 4096,
            url: "./data.sqlite"
          }
        }],
        "https://unpkg.com/sql.js-httpvfs/dist/sqlite.worker.sql-wasm.js"
      );

      async function q(sql, params=[]) {
        return await worker.db.query(sql, params);
      }

      // DataTable
      const table = $('#report').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        scrollX: true,
        lengthMenu: [[10,25,50,100],[10,25,50,100]],
        ajax: async (data, callback) => {
          const start = data.start || 0;
          const length = data.length || 25;
          const colMap = ["owner_org","tracking_number","request_number","informal_requests_sum","unique_identifiers"];
          const orderCol = colMap[(data.order?.[0]?.column ?? 0)] || "owner_org";
          const orderDir = (data.order?.[0]?.dir ?? "asc").toUpperCase() === "DESC" ? "DESC" : "ASC";

          const totalRes = await q("SELECT COUNT(*) AS c FROM strong_matches");
          const recordsTotal = totalRes[0]?.c || 0;

          const rows = await q(
            `SELECT owner_org, tracking_number, request_number, informal_requests_sum, unique_identifiers, summary_en, summary_fr
             FROM strong_matches
             ORDER BY ${orderCol} ${orderDir}
             LIMIT ? OFFSET ?`,
            [length, start]
          );

          const dataRows = rows.map(r => [
            r.owner_org,
            r.tracking_number,
            r.request_number,
            r.informal_requests_sum || 0,
            r.unique_identifiers || "",
            r.summary_en || "",
            r.summary_fr || ""
          ]);

          callback({
            draw: data.draw,
            recordsTotal,
            recordsFiltered: recordsTotal,
            data: dataRows
          });
        },
        columns: [
          { title: "Org", data: 0 },
          { title: "Tracking #", data: 1, render: (d,t,row)=>
            `<a href="https://search.open.canada.ca/briefing_titles/record/${row[0]},${d}" target="_blank">${d}</a>` },
          { title: "Request #", data: 2, render: (d,t,row)=>
            `<a href="https://open.canada.ca/data/en/dataset/0797e893-751e-4695-8229-a5066e4fe43c/resource/19383ca2-b01a-487d-88f7-e1ffbc7d39c2?filters=owner_org%3A${row[0]}%7Crequest_number%3A${d}" target="_blank">${d}</a>` },
          { title: "Informal Requests", data: 3, className:'dt-right', render:(d)=>Number(d||0).toLocaleString() },
          { title: "UIDs", data: 4 },
          { title: "Summary EN", data: 5, visible:false },
          { title: "Summary FR", data: 6, visible:false }
        ]
      });

      // Expand details to show summaries
      $('#report tbody').on('click', 'tr', function () {
        const row = table.row(this);
        if (row.child.isShown()) {
          row.child.hide(); $(this).removeClass('shown');
        } else {
          const d = row.data();
          row.child(`<div><strong>EN:</strong> ${d[5]}<br><strong>FR:</strong> ${d[6]}</div>`).show();
          $(this).addClass('shown');
        }
      });

      // Weak table
      const weakRows = await q(`SELECT owner_org, tracking_number, COUNT(*) as n
                                FROM weak_matches GROUP BY owner_org, tracking_number`);
      let html = "<table border='1'><tr><th>Org</th><th>Tracking #</th><th>Count</th></tr>";
      weakRows.forEach(r=>{
        html += `<tr><td>${r.owner_org}</td><td>${r.tracking_number}</td><td>${r.n}</td></tr>`;
      });
      html += "</table>";
      document.getElementById("weak-table").innerHTML = html;
    })();
  </script>

<script>
(function(){
  // ---------- tiny helpers for dynamic assets ----------
  function addCSS(href){
    return new Promise(function(resolve,reject){
      if ([...document.styleSheets].some(s => s.href && s.href.includes(href))) return resolve();
      const l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
      l.onload=resolve; l.onerror=reject; document.head.appendChild(l);
    });
  }
  function addScript(src){
    return new Promise(function(resolve,reject){
      if ([...document.scripts].some(s => s.src && s.src.includes(src))) return resolve();
      const s=document.createElement('script'); s.src=src; s.defer=true;
      s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
    });
  }

  // ---------- ensure DataTables v2 + SearchBuilder 1.8.3 + Chart.js 4 ----------
  async function ensureLibs(){
    if (!window.jQuery) await addScript("https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js");

    // DataTables v2 core
    await addCSS("https://cdn.datatables.net/2.0.8/css/dataTables.dataTables.min.css");
    await addScript("https://cdn.datatables.net/2.0.8/js/dataTables.min.js");

    // SearchBuilder
    await addCSS("https://cdn.datatables.net/searchbuilder/1.8.3/css/searchBuilder.dataTables.min.css");
    await addScript("https://cdn.datatables.net/searchbuilder/1.8.3/js/dataTables.searchBuilder.min.js");

    // Chart.js v4
    if (!window.Chart) await addScript("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js");
  }

  // ---------- utilities ----------
  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>"']/g, m => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[m]));
  }
  function linkOwnerOrg(val){
    const raw = String(val || '');
    const slug = encodeURIComponent(raw.toLowerCase());
    const url = `https://search.open.canada.ca/briefing_titles/?owner_org=${slug}`;
    return `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(raw)}</a>`;
  }
  function linkUIDs(val){
    const raw = String(val || '');
    if (!raw.trim()) return '';
    const parts = raw.split(';').map(s => s.trim()).filter(Boolean);
    const base = "https://open.canada.ca/en/search/ati/reference/";
    return parts.map(id => `<a href="${base}${encodeURIComponent(id)}" target="_blank" rel="noopener">${escapeHtml(id)}</a>`).join("<br>");
  }

  // tracking_number record link: https://search.open.canada.ca/briefing_titles/record/{owner_org},{tracking_number}
  function linkTrackingNumber(owner_org, tracking_number){
    const org = String(owner_org || '');
    const tn  = String(tracking_number || '');
    if (!org || !tn) return escapeHtml(tn);
    const url = `https://search.open.canada.ca/briefing_titles/record/${encodeURIComponent(org)},${encodeURIComponent(tn)}`;
    return `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(tn)}</a>`;
  }

  // request_number link to C dataset with encoded filters
  function linkRequestNumber(owner_org, request_number){
    const org = String(owner_org || '');
    const rn  = String(request_number || '');
    if (!org || !rn) return escapeHtml(rn);
    const filterVal = `owner_org:${org}|request_number:${rn}`;
    const url = "https://open.canada.ca/data/en/dataset/0797e893-751e-4695-8229-a5066e4fe43c/resource/19383ca2-b01a-487d-88f7-e1ffbc7d39c2?filters=" + encodeURIComponent(filterVal);
    return `<a href="${url}" target="_blank" rel="noopener">${escapeHtml(rn)}</a>`;
  }

  function buildDetails(row){
    // row = [owner_org, tracking_number, request_number, sum, unique_ids, summary_en, summary_fr]
    const owner = row[0] ?? '';
    const tn = row[1] ?? '';
    const rn = row[2] ?? '';
    const sum = Number(row[3] || 0);
    const uids = row[4] ?? '';
    const s_en = row[5] ?? '';
    const s_fr = row[6] ?? '';
    return `
      <div class="dt-details">
        <h4>Full details</h4>
        <p><strong>owner_org:</strong> ${escapeHtml(owner)}</p>
        <p><strong>tracking_number:</strong> ${linkTrackingNumber(owner, tn)}</p>
        <p><strong>request_number:</strong> ${linkRequestNumber(owner, rn)}</p>
        <p><strong>Informal Requests (sum):</strong> ${sum.toLocaleString()}</p>
        <p><strong>Unique Identifier(s):</strong><br>${linkUIDs(uids)}</p>
        <p><strong>summary_en:</strong><br>${escapeHtml(s_en)}</p>
        <p><strong>summary_fr:</strong><br>${escapeHtml(s_fr)}</p>
      </div>`;
  }

  function toRows(json){
    return (json?.rows || []).map(r => ([
      r.owner_org || '',
      r.tracking_number || '',
      r.c_request_number || '',
      (r.informal_requests_sum || 0),
      r.unique_identifiers || '',
      r.summary_en || '',
      r.summary_fr || ''
    ]));
  }

  // stats with dataset links
  function updateStats(data){
    const statsEl = document.getElementById('bn-ati-stats');
    if (!statsEl) return;

    const A = Number(data.meta?.counts?.A_rows||0).toLocaleString();
    const B = Number(data.meta?.counts?.B_rows||0).toLocaleString();
    const C = Number(data.meta?.counts?.C_rows||0).toLocaleString();
    const BC = Number(data.meta?.counts?.BC_rows||0).toLocaleString();
    const matches = Number(data.meta?.counts?.matches||0).toLocaleString();
    const strong = Number(data.meta?.counts?.strong_matches||0).toLocaleString();
    const weak = Number(data.meta?.counts?.weak_matches||0).toLocaleString();

    const linkA = `<a href="https://open.canada.ca/data/en/dataset/ee9bd7e8-90a5-45db-9287-85c8cf3589b6/resource/299a2e26-5103-4a49-ac3a-53db9fcc06c7" target="_blank" rel="noopener">Proactive Disclosure - Briefing Note Titles and Numbers</a>`;
    const linkB = `<a href="https://open.canada.ca/data/en/dataset/2916fad5-ebcc-4c86-b0f3-4f619b29f412/resource/e664cf3d-6cb7-4aaa-adfa-e459c2552e3e" target="_blank" rel="noopener">Analytics - ATI informal requests per summary</a>`;
    const linkC = `<a href="https://open.canada.ca/data/dataset/0797e893-751e-4695-8229-a5066e4fe43c/resource/19383ca2-b01a-487d-88f7-e1ffbc7d39c2" target="_blank" rel="noopener">Completed Access to Information Request Summaries dataset</a>`;

    statsEl.innerHTML = `
      <div>
        <strong>Summary</strong> —
        <br> ${linkA}: ${A}
        <br> ${linkB}: ${B}
        <br> ${linkC}: ${C}
        <br> Joined ATI Summaries and Informal Request Data (merged): ${BC}
        <br> Matches of BN Reference Number to ATI Summary Description Same Org: ${matches}
        <br> Strong Matches - Weak IDs Removed: ${strong}
        <br> Weak Matches BN Ref Numbers such as NA, 0, or '-' cause false positive matches: ${weak}
      </div>`;
  }

  // ---------- weak-id aggregation for Section 2 ----------
  const WEAK_VALUES = ["c","1","0","NA","na","-","REDACTED","[REDACTED]","TBD-PM-00"];

  function aggWeakCounts(weakJson){
    const counts = new Map(); // owner_org -> {weakVal:count}
    for (const r of (weakJson?.rows || [])){
      const org = (r.owner_org || "").trim();
      const tn  = (r.tracking_number || "").trim();
      if (!org || !tn) continue;
      const weakKey = WEAK_VALUES.includes(tn) ? tn : null;
      if (!weakKey) continue;
      if (!counts.has(org)) counts.set(org, Object.fromEntries(WEAK_VALUES.map(v => [v, 0])));
      counts.get(org)[weakKey] += 1;
    }
    const owners = Array.from(counts.keys()).sort();
    const perWeak = {};
    for (const w of WEAK_VALUES) perWeak[w] = owners.map(o => counts.get(o)[w] || 0);
    const totals = owners.map(o => WEAK_VALUES.reduce((sum,w) => sum + (counts.get(o)[w]||0), 0));
    return { owners, perWeak, totals };
  }

  function renderWeakTable(agg){
    const tbody = document.querySelector("#weakTable tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    for (let i=0;i<agg.owners.length;i++){
      const org = agg.owners[i];
      const row = document.createElement("tr");
      const cells = [
        org,
        ...WEAK_VALUES.map(w => String(agg.perWeak[w][i])),
        String(agg.totals[i])
      ];
      for (const c of cells){
        const td = document.createElement("td");
        td.textContent = c;
        row.appendChild(td);
      }
      tbody.appendChild(row);
    }
  }

  function colorPalette(n){
    const base = ["#8ecae6","#219ebc","#023047","#ffb703","#fb8500",
                  "#90be6d","#277da1","#577590","#f94144","#f3722c"];
    if (n <= base.length) return base.slice(0,n);
    const arr = [];
    while (arr.length < n) arr.push(...base);
    return arr.slice(0,n);
  }

  function renderWeakChart(agg){
    const ctx = document.getElementById("weakChart");
    if (!ctx || !window.Chart) return;
    const colors = colorPalette(WEAK_VALUES.length);
    const datasets = WEAK_VALUES.map((w, idx) => ({
      label: w,
      data: agg.perWeak[w],
      backgroundColor: colors[idx],
      stack: "weak"
    }));
    new Chart(ctx, {
      type: "bar",
      data: { labels: agg.owners, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { stacked: true, ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } },
          y: { stacked: true, beginAtZero: true }
        },
        plugins: {
          legend: { position: "top", labels: { font: { size: 16 } } },
          title: { display: true, text: "Weak BN IDs per Owner Org", font: { size: 20 } },
          tooltip: { mode: "index", intersect: false }
        }
      }
    });
  }

  // Only Records Informally Requested preset (Section 1)
  const PRESET_INFORMAL = {
    criteria: [{ data: 'Informal Requests (sum)', condition: '>=', value: [1] }],
    logic: 'AND'
  };

  async function main(){
    await ensureLibs();

    // ---- Load strong matches report.json directly
    const reportRes = await fetch('./report.json', { cache: 'no-store' });
    const data = await reportRes.json();

    updateStats(data);

    const rows = toRows(data);
    const tableEl = document.getElementById('report');

    const dt = jQuery(tableEl).DataTable({
      data: rows,
      deferRender: true,
      autoWidth: false,
      scrollX: true,
      pageLength: 25,
      lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"All"]],
      order: [[0, "asc"]],
      dom: 'Qlfrtip',
      searchBuilder: { columns: [0,1,2,3,4,5,6] },
      columns: [
        // owner_org → hyperlink on display, raw for search/sort
        { data: 0, render: (d,t)=> t==='display' ? linkOwnerOrg(d) : (d ?? '') },
        // tracking_number → record link using owner_org + tracking_number
        { data: 1, render: function(d, type, row){ return type==='display' ? linkTrackingNumber(row[0], d) : (d ?? ''); } },
        // request_number → filters link with owner_org + request_number
        { data: 2, render: function(d, type, row){ return type==='display' ? linkRequestNumber(row[0], d) : (d ?? ''); } },
        // numeric sum
        { data: 3, className:'dt-right', render:(d,t)=>{const n=Number(d||0); return t==='display'? n.toLocaleString(): n;} },
        // Unique Identifier(s) → links on display
        { data: 4, render:(d,t)=> t==='display' ? linkUIDs(d) : (d ?? '') },
        // summary_en (hidden)
        { data: 5, visible: false },
        // summary_fr (hidden)
        { data: 6, visible: false }
      ]
    });

    // Row expansion toggle: show hidden summaries + details
    jQuery('#report tbody').on('click', 'tr', function(){
      const row = dt.row(this);
      if (row.child.isShown()) { row.child.hide(); jQuery(this).removeClass('shown'); }
      else { row.child(buildDetails(row.data())).show(); jQuery(this).addClass('shown'); }
    });

    // Preset buttons (Section 1)
    const btnInformal = document.getElementById('preset-informal');
    const btnClear = document.getElementById('preset-clear');
    if (btnInformal) btnInformal.addEventListener('click', () => dt.searchBuilder.rebuild(PRESET_INFORMAL));
    if (btnClear) btnClear.addEventListener('click', () => dt.searchBuilder.rebuild());

    // ---- Load weak matches weak_bn_id.json directly (for Section 2)
    try{
      const weakRes = await fetch('./weak_bn_id.json', { cache: 'no-store' });
      const weakData = await weakRes.json();
      const agg = aggWeakCounts(weakData);
      renderWeakChart(agg);
      renderWeakTable(agg);
    }catch(e){
      console.warn("Failed to load weak_bn_id.json", e);
    }
  }

  main().catch(console.error);
})();
</script>
</body>
</html>
